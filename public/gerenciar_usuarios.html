<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Usuários</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
    .container { max-width: 900px; margin: auto; }
    h1, h2 { color: #0056b3; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
    .formulario-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 40px; }
    label { display: block; margin-top: 15px; font-weight: 600; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 20px; transition: background-color 0.2s; }
    button[type="submit"] { background-color: #007BFF; color: white; }
    .btn-edit, .btn-delete { padding: 5px 10px; font-size: 12px; margin-right: 5px; }
    .btn-edit { background-color: #ffc107; color: #333; }
    .btn-delete { background-color: #dc3545; color: white; }
    #cancelar-edicao { background-color: #6c757d; color: white; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: left; font-size: 14px; }
    th { background-color: #e9ecef; }
    .hidden { display: none; }
    .link-voltar { display: inline-block; margin-bottom: 20px; color: #0056b3; text-decoration: none; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard.html" class="link-voltar">&larr; Voltar ao Painel</a>
    <h1>Gerenciamento de Usuários</h1>
    <section class="formulario-container">
      <h2 id="form-title">Cadastrar Novo Usuário</h2>
      <p id="first-user-message" class="hidden"><b>Importante:</b> Como este é o primeiro usuário, ele será criado como <b>Admin</b>.</p>
      <form id="user-form">
        <input type="hidden" id="user-id">
        <label for="nome-user">Nome Completo:</label><input type="text" id="nome-user" required>
        <label for="login-user">Login:</label><input type="text" id="login-user" required>
        <label for="senha-user">Senha:</label><input type="password" id="senha-user">
        <label for="tipo-user">Tipo de Usuário:</label>
        <select id="tipo-user"><option value="Operador">Operador</option><option value="Admin">Admin</option></select>
        <button type="submit" id="btn-salvar">Salvar</button>
        <button type="button" id="cancelar-edicao" class="hidden">Cancelar</button>
      </form>
    </section>
    <section class="lista-container">
      <h2>Usuários Cadastrados</h2>
      <table id="tabela-users">
        <thead><tr><th>Nome</th><th>Login</th><th>Tipo</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
  <script>
    const form = document.getElementById('user-form');
    const tabelaBody = document.querySelector('#tabela-users tbody');
    const hiddenUserId = document.getElementById('user-id');
    const nomeInput = document.getElementById('nome-user');
    const loginInput = document.getElementById('login-user');
    const senhaInput = document.getElementById('senha-user');
    const tipoSelect = document.getElementById('tipo-user');
    const firstUserMessage = document.getElementById('first-user-message');
    
    let users_carregados = [];

    const getAuthHeader = (isPostOrPut = false) => {
        const token = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${token}` };
        if (isPostOrPut) headers['Content-Type'] = 'application/json';
        return headers;
    };

    async function renderizarTabela() {
        tabelaBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
        try {
            const response = await fetch('/api/users', { headers: getAuthHeader() });
            if (response.status === 401 || response.status === 403) return window.location.href = 'index.html';
            users_carregados = await response.json();

            // Lógica para o primeiro usuário
            if (users_carregados.length === 0) {
                firstUserMessage.classList.remove('hidden');
                tipoSelect.value = 'Admin';
                tipoSelect.disabled = true;
            } else {
                firstUserMessage.classList.add('hidden');
                tipoSelect.disabled = false;
            }

            tabelaBody.innerHTML = '';
            users_carregados.forEach(u => {
                const row = tabelaBody.insertRow();
                row.innerHTML = `
                  <td>${u.nome}</td><td>${u.login}</td><td>${u.tipo}</td>
                  <td>
                    <button class="btn-edit" onclick="prepararEdicao('${u._id}')">Editar</button>
                    <button class="btn-delete" onclick="excluirUser('${u._id}')">Excluir</button>
                  </td>`;
            });
        } catch (error) {
            tabelaBody.innerHTML = '<tr><td colspan="4">Erro ao carregar. Apenas Admins podem ver usuários.</td></tr>';
        }
    }
    
    function prepararEdicao(id) {
        const u = users_carregados.find(user => user._id === id);
        if(!u) return;
        hiddenUserId.value = u._id;
        nomeInput.value = u.nome;
        loginInput.value = u.login;
        tipoSelect.value = u.tipo;
        senhaInput.placeholder = "Deixe em branco para não alterar";
        senhaInput.required = false;
        document.getElementById('form-title').textContent = 'Editando Usuário';
        document.getElementById('btn-salvar').textContent = 'Salvar Alterações';
        document.getElementById('cancelar-edicao').classList.remove('hidden');
    }

    async function excluirUser(id) {
        if (!confirm('Tem certeza?')) return;
        await fetch(`/api/users/${id}`, { method: 'DELETE', headers: getAuthHeader() });
        renderizarTabela();
    }
    
    function limparFormulario() {
        form.reset();
        hiddenUserId.value = '';
        senhaInput.placeholder = "";
        senhaInput.required = true;
        document.getElementById('form-title').textContent = 'Cadastrar Novo Usuário';
        document.getElementById('btn-salvar').textContent = 'Salvar';
        document.getElementById('cancelar-edicao').classList.add('hidden');
        if (users_carregados.length === 0) {
            tipoSelect.value = 'Admin';
            tipoSelect.disabled = true;
        } else {
            tipoSelect.disabled = false;
        }
    }

    window.addEventListener('DOMContentLoaded', renderizarTabela);
    document.getElementById('cancelar-edicao').addEventListener('click', limparFormulario);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = hiddenUserId.value;
      const userData = {
        nome: nomeInput.value,
        login: loginInput.value,
        tipo: tipoSelect.value
      };
      if (senhaInput.value) userData.senha = senhaInput.value;
      if (!id && !userData.senha) return alert("A senha é obrigatória para criar um novo usuário.");

      const url = id ? `/api/users/${id}` : '/api/users';
      const method = id ? 'PUT' : 'POST';
      // Para o primeiro usuário, não precisamos de token, a API permite
      const headers = users_carregados.length === 0 ? { 'Content-Type': 'application/json' } : getAuthHeader(true);
      
      const response = await fetch(url, { method, headers, body: JSON.stringify(userData) });
      if (!response.ok) return alert('Erro ao salvar usuário.');
      
      // Se era o primeiro usuário, redireciona para o login
      if (users_carregados.length === 0) {
          alert('Primeiro usuário Admin criado com sucesso! Agora você será redirecionado para a tela de login.');
          return window.location.href = 'index.html';
      }

      renderizarTabela();
      limparFormulario();
    });
  </script>
</body>
</html>