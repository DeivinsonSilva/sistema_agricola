<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatórios de Atividades</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
    .container { max-width: 1100px; margin: auto; padding: 2rem; }
    h1, h2 { color: #0056b3; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
    .no-print { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .filtros, .tipo-relatorio { display: flex; align-items: flex-end; gap: 20px; flex-wrap: wrap; }
    .tipo-relatorio { margin-bottom: 20px; }
    label { display: block; font-weight: 600; margin-bottom: 5px; }
    input[type="month"], input[type="date"] { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: background-color 0.2s; }
    #btn-gerar { background-color: #007BFF; }
    #btn-pdf { background-color: #dc3545; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #area-impressao { background-color: white; }
    #pdf-table-container { display: none; } /* Escondido por padrão */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 10pt; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .report-header { text-align: center; margin-bottom: 30px; padding-top: 2cm; }
    .report-header h2 { border: none; }
    .report-footer { text-align: right; margin-top: 20px; font-size: 9pt; color: #777; padding-bottom: 2cm; }
    .hidden { display: none; }
    .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 1rem; background-color: #e9ecef; border-radius: 5px; }
    .pagination-controls button { background-color: #6c757d; padding: 8px 16px; }
  </style>
</head>
<body>

  <header id="header-placeholder"></header>

  <div class="container">
    <h1>Relatórios de Atividades Diárias</h1>

    <div class="no-print">
      <h2>Filtros e Ações</h2>
      <div class="tipo-relatorio">
        <label><input type="radio" name="tipoRelatorio" value="diario" checked> Diário</label>
        <label><input type="radio" name="tipoRelatorio" value="mensal"> Mensal</label>
      </div>
      <div class="filtros">
        <div id="filtro-diario"><label for="dia-input">Dia:</label><input type="date" id="dia-input"></div>
        <div id="filtro-mensal" class="hidden"><label for="mes-ano-input">Mês/Ano:</label><input type="month" id="mes-ano-input"></div>
        <button id="btn-gerar">Gerar Relatório</button>
        <button id="btn-pdf" disabled>Baixar PDF Completo</button>
      </div>
    </div>
    
    <div id="report-container" class="card" style="background: white; padding: 20px; border-radius: 8px;"></div>
    <div id="pagination-container" class="no-print"></div>

  </div>
  
  <!-- Container invisível para gerar o PDF completo -->
  <div id="pdf-container" style="position: absolute; left: -9999px; top: -9999px;"></div>

  <footer id="footer-placeholder"></footer>
  
  <script src="layout.js"></script>
  <script>
    const reportContainer = document.getElementById('report-container');
    const paginationContainer = document.getElementById('pagination-container');
    const pdfContainer = document.getElementById('pdf-container');
    const btnGerar = document.getElementById('btn-gerar');
    const btnPdf = document.getElementById('btn-pdf');
    const radiosTipoRelatorio = document.querySelectorAll('input[name="tipoRelatorio"]');
    const diaInput = document.getElementById('dia-input');
    const mesAnoInput = document.getElementById('mes-ano-input');

    let currentReportParams = {};

    const getAuthHeader = () => ({ headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
    const formatarData = (dataISO) => {
        if (!dataISO) return '';
        const [ano, mes, dia] = dataISO.split('T')[0].split('-');
        return `${dia}/${mes}/${ano}`;
    };
    
    function toggleFiltro() {
      const tipo = document.querySelector('input[name="tipoRelatorio"]:checked').value;
      document.getElementById('filtro-diario').classList.toggle('hidden', tipo !== 'diario');
      document.getElementById('filtro-mensal').classList.toggle('hidden', tipo !== 'mensal');
    }

    radiosTipoRelatorio.forEach(radio => radio.addEventListener('change', toggleFiltro));
    
    btnGerar.addEventListener('click', () => {
        const tipo = document.querySelector('input[name="tipoRelatorio"]:checked').value;
        currentReportParams = { tipo };
        if (tipo === 'diario') {
            if (!diaInput.value) return alert("Selecione um dia.");
            currentReportParams.data = diaInput.value;
        } else {
            if (!mesAnoInput.value) return alert("Selecione um mês e ano.");
            const [ano, mes] = mesAnoInput.value.split('-');
            currentReportParams.ano = ano;
            currentReportParams.mes = mes;
        }
        fetchAndRenderReport(1);
    });

    async function fetchAndRenderReport(page = 1) {
        let url = '';
        if (currentReportParams.tipo === 'diario') {
            url = `/api/registros/por-dia?data=${currentReportParams.data}&page=${page}`;
        } else {
            url = `/api/registros/por-mes?ano=${currentReportParams.ano}&mes=${currentReportParams.mes}&page=${page}`;
        }
        reportContainer.innerHTML = "<p>Gerando relatório...</p>";
        paginationContainer.innerHTML = "";
        btnPdf.disabled = true;

        try {
            const response = await fetch(url, getAuthHeader());
            if (response.status === 401 || response.status === 403) return window.location.href = 'index.html';
            const data = await response.json();
            
            renderTable(data.registros, reportContainer);
            renderPagination(data.currentPage, data.totalPages);
            
            if (data.registros.length > 0) {
                btnPdf.disabled = false;
            }
        } catch (error) {
            reportContainer.innerHTML = "<p style='color:red;'>Erro ao gerar relatório.</p>";
        }
    }

    function renderTable(registros, container) {
        let tabelaHtml = `
            <table>
              <thead><tr><th>Data</th><th>Trabalhador</th><th>Status</th><th>Fazenda</th><th>Serviço/Motivo</th><th>Produção</th><th>Preço Unit.</th><th>Total</th></tr></thead>
              <tbody>`;
        registros.forEach(reg => {
          const totalLinha = (reg.producao && reg.preco) ? reg.producao * reg.preco : 0;
          tabelaHtml += `
            <tr><td>${formatarData(reg.data)}</td><td>${reg.nome}</td><td>${reg.status}</td><td>${reg.fazenda || '---'}</td>
            <td>${reg.detalhes || '---'}</td><td>${reg.producao || '0'}</td><td>R$ ${reg.preco ? reg.preco.toFixed(2) : '0.00'}</td>
            <td>R$ ${totalLinha.toFixed(2)}</td></tr>`;
        });
        tabelaHtml += `</tbody></table>`;
        container.innerHTML = tabelaHtml;
    }

    function renderPagination(currentPage, totalPages) {
        if (totalPages <= 1) return;
        const prevButton = `<button onclick="fetchAndRenderReport(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&larr; Anterior</button>`;
        const pageInfo = `<span>Página ${currentPage} de ${totalPages}</span>`;
        const nextButton = `<button onclick="fetchAndRenderReport(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Próxima &rarr;</button>`;
        paginationContainer.innerHTML = `<div class="pagination-controls">${prevButton} ${pageInfo} ${nextButton}</div>`;
    }

    btnPdf.addEventListener('click', async () => {
        btnPdf.disabled = true;
        btnPdf.textContent = 'Gerando PDF...';

        try {
            let url = `/api/registros/todos?tipo=${currentReportParams.tipo}`;
            if (currentReportParams.tipo === 'diario') url += `&data=${currentReportParams.data}`;
            else url += `&ano=${currentReportParams.ano}&mes=${currentReportParams.mes}`;

            const response = await fetch(url, getAuthHeader());
            const data = await response.json();

            let periodo = '';
            if (currentReportParams.tipo === 'diario') {
                periodo = `Dia: <strong>${formatarData(currentReportParams.data + 'T00:00:00')}</strong>`;
            } else {
                const nomeMes = new Date(currentReportParams.ano, currentReportParams.mes - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                periodo = `Mês de Referência: <strong>${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)} de ${currentReportParams.ano}</strong>`;
            }

            const dataGeracao = new Date().toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' });
            
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div class="report-header"><h2>Relatório de Atividades</h2><p>${periodo}</p></div>
                <div id="pdf-table-container"></div>
                <div class="report-footer">Relatório gerado em: ${dataGeracao}</div>
            `;
            renderTable(data.registros, pdfContent.querySelector('#pdf-table-container'));
            pdfContainer.innerHTML = '';
            pdfContainer.appendChild(pdfContent);

            const elemento = pdfContainer.firstChild;
            const opt = { margin: 1, filename: `relatorio_completo.pdf`, image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 }, jsPDF: { unit: 'cm', format: 'a4', orientation: 'landscape' } };
            
            html2pdf().set(opt).from(elemento).save();

        } catch (error) {
            alert('Erro ao gerar o PDF completo.');
        } finally {
            btnPdf.disabled = false;
            btnPdf.textContent = 'Baixar PDF Completo';
        }
    });

    (function setDefaultDates() {
      const hoje = new Date().toISOString().split('T')[0];
      diaInput.value = hoje;
      mesAnoInput.value = hoje.substring(0, 7);
      toggleFiltro();
    })();
  </script>
</body>
</html>
